#include <stdio.h>
#include <errno.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>

#define OUTPUT(statement) printf("%s%s\n", loop, statement)
#define OUTPUT_NOTAB(statement) printf("%s\n", statement)

typedef unsigned char INPUTMODE;
#define DEFAULT_MODE (INPUTMODE)0
#define SPECIAL_MODE (INPUTMODE)1

inline static void maketemplated(const char* template, int argument, char loop[]) {
	/* add five for safety. completely arbitrary */
	char* buffer = malloc(strlen(template) + 5);
	snprintf(buffer, strlen(template) + 5, template, argument);
	OUTPUT(buffer);
	free(buffer);
}

int main(int argc, char** argv) {
	FILE* input = stdin;

	if (argc > 1) input = fopen(argv[1], "r");
	if (input == NULL) {
		fprintf(stderr, "%s: error: %m\n", argv[0]);
		return 50 + (errno % 20);
	}

	/* stores tab characters */
	char loop[256];
	for (int i = 1; i < 256; i++) loop[i] = 0;
	loop[0] = '\t';

	int marker = 0;

	char current;
	OUTPUT_NOTAB("/* generated by bran */");
	OUTPUT_NOTAB("#include <stdio.h>");
	OUTPUT_NOTAB("");
	OUTPUT_NOTAB("char buffer[1024];");
	OUTPUT_NOTAB("");
	OUTPUT_NOTAB("int main(void)");
	OUTPUT_NOTAB("{");
	OUTPUT("register unsigned int offset = 0;");
	OUTPUT("unsigned int iregisters[8];   /* integer registers */");
	OUTPUT("char* sregisters[8];          /* string registers (not null-terminated) */");
	OUTPUT("unsigned char lregisters[8];  /* string length registers */");

	INPUTMODE mode = DEFAULT_MODE;

	while ((current = fgetc(input)) != EOF) {
		if (mode == SPECIAL_MODE) {
			mode = DEFAULT_MODE;
			if (current >= 'a' && current <= 'f') {
				maketemplated("iregisters[%d] = buffer[offset];", current - 'a', loop);
			} else if (current >= 'A' && current <= 'F') {
				maketemplated("buffer[offset] = iregisters[%d];", current - 'A', loop);
			} else if (current >= 's' && current <= 'z') {
				maketemplated("lregisters[%d] = buffer[offset];", current - 's', loop);
				maketemplated("sregisters[%d] = (&buffer[offset]) - buffer[offset];", current - 's', loop);
			} else if (current >= 'S' && current <= 'Z') {
				OUTPUT("if (1) {");
				maketemplated("\tunsigned char len = lregisters[%d];", current - 'S', loop);
				OUTPUT("\tregister char position;");
				maketemplated("\tfor (position = 0; position < len; position++) ((&buffer[offset] - len) + postition) = sregisters[%d][position];", current - 'S', loop);
				OUTPUT("} /* end scope */");
			}

			continue;
		}

		switch (current) {
			case '>':
				OUTPUT("offset++;");
				break;
			case '<':
				OUTPUT("offset--;");
				break;
			case '+':
				OUTPUT("buffer[offset]++;");
				break;
			case '-':
				OUTPUT("buffer[offset]--;");
				break;
			case '.':
				OUTPUT("printf(\"\%c\", buffer[offset]);");
				break;
			case ',':
				OUTPUT("buffer[offset] = getchar();");
				break;
			case '[':
				OUTPUT("while (buffer[offset] != 0)");
				OUTPUT("{");
				for (int i = 0; i < 8; i++)
					if (loop[i] != '\t' && (loop[i] = '\t'))
						break;
				break;
			case ']':
				for (int i = 7; i --> 0;)
					if (loop[i] == '\t' && (loop[i] = 0) == 0)
						break;
				OUTPUT("} /* end while */");
				break;
			case '$':
				mode = SPECIAL_MODE;
				break;
			case '%':
				OUTPUT("printf(\"%.*s\", lregisters['Z' - 'S'], sregisters['Z' - 'S']);");
				break;
			case '^':
				maketemplated("goto marker%d;", marker, loop);
				break;
			case '*':
				marker++;
				maketemplated("marker%d:", marker, "");
				break;
		}
	}

	OUTPUT_NOTAB("\treturn 0;");
	OUTPUT_NOTAB("}");
	OUTPUT_NOTAB("/* eof */");

	return EXIT_SUCCESS;
}
